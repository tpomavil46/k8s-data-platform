apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: superset
  namespace: argocd
spec:
  project: default
  destination:
    server: https://kubernetes.default.svc
    namespace: superset
  source:
    repoURL: https://apache.github.io/superset
    chart: superset
    targetRevision: 0.12.11
    helm:
      values: |
        postgresql:
          enabled: false

        # Read DB password + SECRET_KEY from the Secrets generated by ExternalSecrets
        extraSecretEnv:
          SUPERSET_DATABASE_PASSWORD:
            secretKeyRef:
              name: superset-db-secret
              key: password
          SUPERSET_SECRET_KEY:
            secretKeyRef:
              name: superset-secret
              key: secret_key

        extraEnv:
          - name: SUPERSET_LOAD_EXAMPLES
            value: "no"

        # ---- Redis: fix the image tag and (optionally) disable auth for now ----
        redis:
          enabled: true
          image:
            registry: docker.io
            repository: bitnami/redis
            # Use a tag that exists. Example:
            tag: 7.2.4-debian-12-r0
            pullPolicy: IfNotPresent
          auth:
            enabled: false
            # If you want auth, set enabled:true and either:
            # existingSecret: superset-redis
            # existingSecretPasswordKey: redis-password

        supersetNode:
          connections:
            db_host: "172.16.0.20"
            db_port: "5432"
            db_user: "superset"
            db_name: "superset"

        init:
          adminUser:
            username: admin
            password: admin
            email: admin@superset.com

        # Prefer SUPERSET_DATABASE_URI if you add it later; otherwise build from fields above
        configOverrides:
          00_db_uri.py: |
            import os
            SQLALCHEMY_DATABASE_URI = os.getenv("SUPERSET_DATABASE_URI")
            if not SQLALCHEMY_DATABASE_URI:
                user = os.getenv("SUPERSET_DATABASE_USER", "{{ .Values.supersetNode.connections.db_user }}")
                pwd  = os.getenv("SUPERSET_DATABASE_PASSWORD", "")
                host = "{{ .Values.supersetNode.connections.db_host }}"
                port = "{{ .Values.supersetNode.connections.db_port }}"
                name = "{{ .Values.supersetNode.connections.db_name }}"
                SQLALCHEMY_DATABASE_URI = f"postgresql+psycopg2://{user}:{pwd}@{host}:{port}/{name}"

        ingress:
          enabled: false

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true