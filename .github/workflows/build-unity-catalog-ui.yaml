name: Build Unity Catalog UI

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/build-unity-catalog-ui.yaml'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout Unity Catalog
        uses: actions/checkout@v4
        with:
          repository: unitycatalog/unitycatalog
          ref: v0.3.0
          path: unitycatalog

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create production Dockerfile
        run: |
          cd unitycatalog/ui
          cat > Dockerfile.prod <<'EOF'
          FROM node:18-alpine AS builder
          WORKDIR /app
          COPY package*.json yarn.lock ./
          RUN yarn install --frozen-lockfile
          COPY . .
          ENV REACT_APP_UNITY_CATALOG_API_URL=/api
          RUN yarn build

          FROM nginx:alpine
          COPY --from=builder /app/build /usr/share/nginx/html
          
          RUN echo 'server { \
              listen 80; \
              root /usr/share/nginx/html; \
              index index.html; \
              location / { \
                  try_files $uri $uri/ /index.html; \
              } \
              location /api/ { \
                  proxy_pass http://unity-catalog-unitycatalog-server:8080/api/; \
                  proxy_set_header Host $host; \
                  proxy_set_header X-Real-IP $remote_addr; \
              } \
          }' > /etc/nginx/conf.d/default.conf
          
          EXPOSE 80
          CMD ["nginx", "-g", "daemon off;"]
          EOF

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: unitycatalog/ui
          file: unitycatalog/ui/Dockerfile.prod
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/unity-catalog-ui:0.3.0
          platforms: linux/amd64